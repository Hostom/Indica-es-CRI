<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Indicação CRI/ADIM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <main class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Formulário de Indicação</h1>
        <p class="text-center text-gray-500 mb-8">Preencha os campos para acionar a roleta de consultores.</p>
        
        <form id="referral-form">
            
            <fieldset class="mb-6 border-t pt-4">
                <legend class="text-xl font-semibold text-gray-700 mb-4">Dados do Corretor</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nome_corretor" class="block text-sm font-medium text-gray-600 mb-1">Seu Nome:</label>
                        <input type="text" id="nome_corretor" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="unidade_corretor" class="block text-sm font-medium text-gray-600 mb-1">Sua Unidade:</label>
                        <select id="unidade_corretor" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione a unidade...</option>
                            <option value="CRI Brava">CRI Brava</option>
                            <option value="BC">BC</option>
                            <option value="Itapema">Itapema</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset class="mb-6 border-t pt-4">
                <legend class="text-xl font-semibold text-gray-700 mb-4">Dados da Indicação (para Roleta)</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="natureza" class="block text-sm font-medium text-gray-600 mb-1">Natureza:</label>
                        <select id="natureza" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Locacao">Locação</option>
                            <option value="Captacao">Captação</option>
                        </select>
                    </div>
                    <div>
                        <label for="cidade" class="block text-sm font-medium text-gray-600 mb-1">Cidade:</label>
                        <select id="cidade" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Balneario Camboriu">Balneário Camboriú</option>
                            <option value="Itajai">Itajaí</option>
                            <option value="Itapema">Itapema</option>
                        </select>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="border-t pt-4">
                <legend class="text-xl font-semibold text-gray-700 mb-4">Dados do Cliente</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="nome_cliente" class="block text-sm font-medium text-gray-600 mb-1">Nome do Cliente:</label>
                        <input type="text" id="nome_cliente" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="telefone_cliente" class="block text-sm font-medium text-gray-600 mb-1">Telefone:</label>
                        <input type="text" id="telefone_cliente" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label for="descricao_situacao" class="block text-sm font-medium text-gray-600 mb-1">Descrição da Situação:</label>
                    <textarea id="descricao_situacao" rows="4" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: proprietário deseja deixar imóvel... locatário busca aluguel de 12mil..."></textarea>
                </div>
            </fieldset>

            <button type="submit" class="w-full mt-8 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">Enviar Indicação</button>
        </form>

        <div id="resultado-envio" class="mt-6 p-4 rounded-md text-center hidden"></div>
    </main>

    <script>
        document.getElementById('referral-form').addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            const form = e.target;
            const resultadoDiv = document.getElementById('resultado-envio');
            resultadoDiv.classList.remove('hidden');
            resultadoDiv.className = 'mt-6 p-4 rounded-md text-center bg-yellow-100 text-yellow-800';
            resultadoDiv.innerHTML = 'Processando Roleta...';

            const dadosDoFormulario = {
                natureza: document.getElementById('natureza').value, 
                cidade: document.getElementById('cidade').value,
                nome_corretor: document.getElementById('nome_corretor').value, 
                unidade_corretor: document.getElementById('unidade_corretor').value,
                nome_cliente: document.getElementById('nome_cliente').value,
                tel_cliente: document.getElementById('telefone_cliente').value,
                descricao_situacao: document.getElementById('descricao_situacao').value,
            };

            fetch('/api/indicacoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosDoFormulario),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                resultadoDiv.className = 'mt-6 p-4 rounded-md text-center bg-green-100 text-green-800';
                resultadoDiv.innerHTML = `
                    <h3 class="font-bold text-lg">✅ SUCESSO!</h3>
                    <p>Indicação atribuída para: <strong>${data.consultor_sorteado}</strong></p>
                `;
                form.reset();
            })
            .catch(error => {
                resultadoDiv.className = 'mt-6 p-4 rounded-md text-center bg-red-100 text-red-800';
                resultadoDiv.innerHTML = `<h3 class="font-bold">❌ ERRO</h3><p>${error.message || 'Falha na conexão com o servidor.'}</p>`;
            });
        });
    </script>
</body>
</html>
